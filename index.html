<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Complet : API Express + Sequelize</title>
    <meta name="description" content="Guide complet pour crÃ©er une API REST avec Express.js et Sequelize ORM. Tutoriel Ã©tape par Ã©tape avec code rÃ©el et bonnes pratiques.">
    <link rel="stylesheet" href="assets/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš€</text></svg>">
</head>
<body>
    <div class="container">
        <!-- Navigation latÃ©rale -->
        <nav class="sidebar" role="navigation" aria-label="Navigation principale">
            <h2>Sommaire</h2>
            <ul class="nav-menu" role="list">
                <li><a href="#introduction" class="nav-link active">Introduction</a></li>
                
                <li class="chapter">
                    <a href="#planification" class="nav-link chapter-title">1. Configuration</a>
                    <ul class="sub-links">
                        <li><a href="#setup-projet" class="nav-link">1.1 Setup du projet</a></li>
                        <li><a href="#dependances" class="nav-link">1.2 DÃ©pendances</a></li>
                        <li><a href="#environnement" class="nav-link">1.3 Environnement</a></li>
                    </ul>
                </li>
                
                <li><a href="#structure" class="nav-link">2. Architecture</a></li>
                <li><a href="#database" class="nav-link">3. Base de donnÃ©es</a></li>
                
                <li class="chapter">
                    <a href="#responses" class="nav-link chapter-title">4. RÃ©ponses standardisÃ©es</a>
                    <ul class="sub-links">
                        <li><a href="#status-enum" class="nav-link">4.1 Status enum</a></li>
                        <li><a href="#mapping-http" class="nav-link">4.2 Mapping HTTP</a></li>
                        <li><a href="#api-responses" class="nav-link">4.3 API responses</a></li>
                        <li><a href="#service-results" class="nav-link">4.4 Service results</a></li>
                    </ul>
                </li>
                
                <li class="chapter">
                    <a href="#modeles" class="nav-link chapter-title">5. ModÃ¨les</a>
                    <ul class="sub-links">
                        <li><a href="#modele-users" class="nav-link">5.1 ModÃ¨le Users</a></li>
                        <li><a href="#modele-cars" class="nav-link">5.2 ModÃ¨le Cars</a></li>
                        <li><a href="#relations" class="nav-link">5.3 Relations</a></li>
                    </ul>
                </li>
                
                <li><a href="#serveur" class="nav-link">6. Serveur Express</a></li>
                
                <li class="chapter">
                    <a href="#routes" class="nav-link chapter-title">7. Routes & ContrÃ´leurs</a>
                    <ul class="sub-links">
                        <li><a href="#controleurs" class="nav-link">7.1 ContrÃ´leurs</a></li>
                        <li><a href="#routes-rest" class="nav-link">7.2 Routes REST</a></li>
                        <li><a href="#validation" class="nav-link">7.3 Configuration</a></li>
                    </ul>
                </li>
                
                <li><a href="#middleware" class="nav-link">8. Middleware</a></li>
                <li><a href="#assemblage" class="nav-link">9. Assemblage final</a></li>
                <li><a href="#bonnes-pratiques" class="nav-link">10. Bonnes Pratiques</a></li>
            </ul>
        </nav>

        <!-- Contenu principal -->
        <main class="main-content" role="main" aria-label="Contenu principal du guide">
            <!-- En-tÃªte -->
            <header class="header">
                <h1>ğŸš€ Guide Complet : API Express + Sequelize</h1>
                <p>CrÃ©er une API REST robuste depuis zÃ©ro - StratÃ©gie Ã©tape par Ã©tape</p>
            </header>

            <!-- Introduction -->
            <section id="introduction" class="section">
                <h2>ğŸ¯ Introduction</h2>
                <div class="step">
                    <p>Ce guide vous prÃ©sente une <strong>architecture d'API REST robuste</strong> avec <strong>Express.js</strong> et <strong>Sequelize ORM</strong>. Il est basÃ© sur un projet rÃ©el utilisant les bonnes pratiques de l'industrie.</p>
                    
                    <div class="alert alert-info">
                        <span class="alert-icon">ğŸ—ï¸</span>
                        <div>
                            <strong>Architecture multicouches :</strong> Ce guide suit le pattern <strong>Controller â†’ Service â†’ Repository â†’ Model</strong> avec un systÃ¨me de rÃ©ponses standardisÃ©es pour une API maintenable et Ã©volutive.
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <span class="alert-icon">ğŸ’¡</span>
                        <div>
                            <strong>Approche pratique :</strong> Chaque section contient du code rÃ©el testÃ© et fonctionnel que vous pouvez adapter Ã  vos besoins spÃ©cifiques.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Planification -->
            <section id="planification" class="section">
                <h2>ğŸ“‹ 1. Configuration et Planification</h2>
                
                <div id="setup-projet" class="step">
                    <h3><span class="step-number">1</span>ğŸš€ Setup du projet</h3>
                    <p>Commencez par crÃ©er la structure de base de votre projet :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">bash</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>mkdir mon-api
cd mon-api
npm init -y</code></pre>
                    </div>
                </div>

                <div id="dependances" class="step">
                    <h3><span class="step-number">2</span>ğŸ“¦ Installation des dÃ©pendances</h3>
                    
                    <h4>DÃ©pendances principales :</h4>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">bash</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code># DÃ©pendances principales
npm install express sequelize mysql2 dotenv cors helmet

# DÃ©pendances de dÃ©veloppement
npm install -D nodemon eslint prettier

# Si PostgreSQL au lieu de MySQL
npm install pg pg-hstore</code></pre>
                    </div>

                    <div class="alert alert-info">
                        <span class="alert-icon">ğŸ”</span>
                        <div>
                            <strong>Explication des packages :</strong>
                            <ul>
                                <li><code>express</code> : Framework web Node.js</li>
                                <li><code>sequelize</code> : ORM pour bases de donnÃ©es SQL</li>
                                <li><code>mysql2</code> ou <code>pg</code> : Drivers de base de donnÃ©es</li>
                                <li><code>dotenv</code> : Gestion des variables d'environnement</li>
                                <li><code>cors</code> : Gestion des requÃªtes cross-origin</li>
                                <li><code>helmet</code> : SÃ©curisation des headers HTTP</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="environnement" class="step">
                    <h3><span class="step-number">3</span>ğŸ”§ Configuration de l'environnement</h3>
                    <p>CrÃ©ez un fichier <code>.env</code> Ã  la racine :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">env</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code># Serveur
PORT=3000
NODE_ENV=development

# Base de donnÃ©es MySQL
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=monmotdepasse
DB_NAME=ma_base
DB_DIALECT=mysql

# OU PostgreSQL
# DB_HOST=localhost
# DB_USER=postgres
# DB_PASSWORD=1234
# DB_NAME=carsdb
# DB_DIALECT=postgres
# DB_PORT=5432

# SÃ©curitÃ©
JWT_SECRET=mon_secret_super_securise</code></pre>
                    </div>

                    <h4>Configuration package.json :</h4>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">json</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>{
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  }
}</code></pre>
                    </div>
                </div>
            </section>

            <!-- Structure -->
            <section id="structure" class="section">
                <h2>ğŸ“ 2. Architecture des dossiers</h2>
                
                <div class="step">
                    <h3>ğŸ“‚ Architecture multicouches recommandÃ©e</h3>
                    <p>Structure basÃ©e sur un projet rÃ©el utilisant les patterns de l'industrie :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Structure du projet</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <div class="folder-structure">mon-api-express/
â”œâ”€â”€ <span class="folder">config/</span>
â”‚   â””â”€â”€ <span class="file">database.js</span>          <span class="comment"># Configuration Sequelize</span>
â”œâ”€â”€ <span class="folder">models/</span>
â”‚   â”œâ”€â”€ <span class="file">index.js</span>            <span class="comment"># Initialisation des modÃ¨les</span>
â”‚   â”œâ”€â”€ <span class="file">cars.model.js</span>       <span class="comment"># ModÃ¨le Cars avec relations</span>
â”‚   â””â”€â”€ <span class="file">users.model.js</span>      <span class="comment"># ModÃ¨le Users</span>
â”œâ”€â”€ <span class="folder">controllers/</span>
â”‚   â”œâ”€â”€ <span class="file">cars.controller.js</span>  <span class="comment"># Endpoints REST pour Cars</span>
â”‚   â””â”€â”€ <span class="file">users.controller.js</span> <span class="comment"># Endpoints REST pour Users</span>
â”œâ”€â”€ <span class="folder">services/</span>
â”‚   â”œâ”€â”€ <span class="file">cars.services.js</span>    <span class="comment"># Logique mÃ©tier + validations</span>
â”‚   â””â”€â”€ <span class="file">users.services.js</span>   <span class="comment"># Business logic Users</span>
â”œâ”€â”€ <span class="folder">repositories/</span>
â”‚   â”œâ”€â”€ <span class="file">cars.repository.js</span>  <span class="comment"># AccÃ¨s donnÃ©es + requÃªtes complexes</span>
â”‚   â””â”€â”€ <span class="file">users.repository.js</span> <span class="comment"># Abstraction base de donnÃ©es</span>
â”œâ”€â”€ <span class="folder">responses/</span>
â”‚   â”œâ”€â”€ <span class="file">apiCallResult.response.js</span>     <span class="comment"># RÃ©ponses HTTP standardisÃ©es</span>
â”‚   â””â”€â”€ <span class="file">serviceCallResult.response.js</span> <span class="comment"># RÃ©sultats services internes</span>
â”œâ”€â”€ <span class="folder">routes/</span>
â”‚   â”œâ”€â”€ <span class="file">index.js</span>            <span class="comment"># Routes principales</span>
â”‚   â”œâ”€â”€ <span class="file">cars.routes.js</span>      <span class="comment"># Routes Cars avec validations</span>
â”‚   â””â”€â”€ <span class="file">users.routes.js</span>     <span class="comment"># Routes Users</span>
â”œâ”€â”€ <span class="folder">utils/</span>
â”‚   â”œâ”€â”€ <span class="file">serviceStatus.enum.js</span>    <span class="comment"># Ã‰numÃ©rations status</span>
â”‚   â””â”€â”€ <span class="file">statusToHttpCode.utils.js</span> <span class="comment"># Mapping status â†’ HTTP</span>
â”œâ”€â”€ <span class="folder">middleware/</span>
â”‚   â”œâ”€â”€ <span class="file">errorHandler.js</span>     <span class="comment"># Gestion centralisÃ©e erreurs</span>
â”‚   â””â”€â”€ <span class="file">logger.js</span>           <span class="comment"># Logging des requÃªtes</span>
â”œâ”€â”€ <span class="folder">mock/</span>
â”‚   â”œâ”€â”€ <span class="file">carsdatas.json</span>      <span class="comment"># DonnÃ©es de test</span>
â”‚   â””â”€â”€ <span class="file">userdatas.json</span>      <span class="comment"># Mock data pour dev</span>
â”œâ”€â”€ <span class="file">.env</span>                   <span class="comment"># Variables d'environnement</span>
â”œâ”€â”€ <span class="file">index.js</span>              <span class="comment"># Point d'entrÃ©e application</span>
â””â”€â”€ <span class="file">package.json</span>          <span class="comment"># DÃ©pendances npm</span></div>
                    </div>

                    <div class="alert alert-success">
                        <span class="alert-icon">âœ…</span>
                        <div>
                            <strong>Avantages de cette architecture :</strong>
                            <ul>
                                <li><strong>SÃ©paration des responsabilitÃ©s</strong> : Chaque couche a un rÃ´le prÃ©cis</li>
                                <li><strong>TestabilitÃ©</strong> : Services et repositories facilement mockables</li>
                                <li><strong>RÃ©ponses standardisÃ©es</strong> : Format consistant pour toute l'API</li>
                                <li><strong>Ã‰volutivitÃ©</strong> : Ajout facile de nouvelles fonctionnalitÃ©s</li>
                                <li><strong>Maintenance</strong> : Code organisÃ© et documentÃ©</li>
                            </ul>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <span class="alert-icon">ğŸ”„</span>
                        <div>
                            <strong>Flux de donnÃ©es :</strong><br>
                            <code>Route â†’ Controller â†’ Service â†’ Repository â†’ Model â†’ Database</code><br>
                            <small>Chaque couche gÃ¨re ses responsabilitÃ©s sans connaÃ®tre les dÃ©tails des autres</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Base de donnÃ©es -->
            <section id="database" class="section">
                <h2>ğŸ—„ï¸ 3. Configuration de la base de donnÃ©es</h2>
                
                <div class="step">
                    <h3><span class="step-number">5</span>ğŸ”§ Configuration PostgreSQL avec Sequelize</h3>
                    <p>Configuration simple et efficace basÃ©e sur un projet rÃ©el :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">config/database.js</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const { Sequelize } = require("sequelize");

const sequelize = new Sequelize({
  dialect: "postgres",
  database: process.env.DB_NAME,
  host: process.env.DB_HOST,
  port: +process.env.DB_PORT,
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  
  // Options recommandÃ©es pour production
  logging: process.env.NODE_ENV === 'development' ? console.log : false,
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
});

module.exports = sequelize;</code></pre>
                    </div>

                    <div class="alert alert-info">
                        <span class="alert-icon">ğŸ—„ï¸</span>
                        <div>
                            <strong>PostgreSQL vs MySQL :</strong> Ce guide utilise PostgreSQL pour ses capacitÃ©s avancÃ©es (JSON, arrays, fonctions window). Adaptez le dialect selon votre BDD.
                        </div>
                    </div>
                </div>

                <div class="step">
                    <h3><span class="step-number">6</span>ğŸ”— Initialisation des modÃ¨les</h3>
                    <p>Pattern d'initialisation simple et Ã©volutif :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">models/index.js</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const sequelize = require("../config/database");
const initModels = require("./models_init");

// Initialisation de tous les modÃ¨les
const models = initModels(sequelize);

module.exports = { 
  sequelize, 
  models 
};</code></pre>
                    </div>

                    <div class="alert alert-warning">
                        <span class="alert-icon">ğŸ› ï¸</span>
                        <div>
                            <strong>Sequelize-auto :</strong> Vous pouvez utiliser <code>sequelize-auto</code> pour gÃ©nÃ©rer automatiquement vos modÃ¨les depuis une base de donnÃ©es existante.
                        </div>
                    </div>
                </div>
            </section>

            <!-- ModÃ¨les -->
            <section id="modeles" class="section">
                <h2>ğŸ“Š 5. ModÃ¨les Sequelize</h2>
                
                <div id="modele-users" class="step">
                    <h3><span class="step-number">12</span>ğŸ‘¤ ModÃ¨le User</h3>
                    <p>CrÃ©ez <code>models/user.model.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const { DataTypes } = require('sequelize');
const { sequelize } = require('./index');

const User = sequelize.define('User', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  firstName: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [2, 50]
    }
  },
  lastName: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [2, 50]
    }
  },
  email: {
    type: DataTypes.STRING(100),
    allowNull: false,
    unique: true,
    validate: {
      isEmail: true
    }
  },
  password: {
    type: DataTypes.STRING(255),
    allowNull: false,
    validate: {
      len: [6, 255]
    }
  },
  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: 'users',
  timestamps: true, // createdAt, updatedAt
  paranoid: true,   // deletedAt (soft delete)
  hooks: {
    beforeCreate: (user) => {
      // Hash du mot de passe ici si nÃ©cessaire
    }
  }
});

module.exports = User;</code></pre>
                    </div>
                </div>

                <div id="modele-cars" class="step">
                    <h3><span class="step-number">13</span>ğŸš— ModÃ¨le Car</h3>
                    <p>CrÃ©ez <code>models/car.model.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const { DataTypes } = require('sequelize');
const { sequelize } = require('./index');

const Car = sequelize.define('Car', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  brand: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true
    }
  },
  model: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true
    }
  },
  year: {
    type: DataTypes.INTEGER,
    allowNull: false,
    validate: {
      min: 1900,
      max: new Date().getFullYear() + 1
    }
  },
  price: {
    type: DataTypes.DECIMAL(10, 2),
    allowNull: false,
    validate: {
      min: 0
    }
  },
  color: {
    type: DataTypes.STRING(30),
    allowNull: true
  },
  isAvailable: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: 'cars',
  timestamps: true,
  paranoid: true
});

module.exports = Car;</code></pre>
                    </div>
                </div>

                <div id="relations" class="step">
                    <h3><span class="step-number">14</span>ğŸ”— Relations entre modÃ¨les</h3>
                    <p>CrÃ©ez <code>models/associations.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const User = require('./user.model');
const Car = require('./car.model');

// Un utilisateur peut avoir plusieurs voitures
User.hasMany(Car, {
  foreignKey: 'userId',
  as: 'cars'
});

// Une voiture appartient Ã  un utilisateur
Car.belongsTo(User, {
  foreignKey: 'userId',
  as: 'owner'
});

module.exports = { User, Car };</code></pre>
                    </div>
                </div>
            </section>

            <!-- Serveur -->
            <section id="serveur" class="section">
                <h2>ğŸ–¥ï¸ 6. CrÃ©ation du serveur de base</h2>
                
                <div class="step">
                    <h3><span class="step-number">15</span>ğŸš€ Serveur Express optimisÃ©</h3>
                    <p>Point d'entrÃ©e simple et efficace basÃ© sur votre architecture :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">index.js</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>require("dotenv").config();
const express = require("express");
const { sequelize } = require("./models");

const { notFoundHandler, errorHandler } = require("./middleware/errorHandler");
const routes = require("./routes");

const app = express();

// Middleware de parsing
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Routes API
app.use("/api", routes);

// Middleware d'erreurs (toujours Ã  la fin)
app.use(notFoundHandler);
app.use(errorHandler);

// Bootstrap de l'application
const bootstrap = async () => {
  try {
    // Test de connexion Ã  la base de donnÃ©es
    await sequelize.authenticate();
    console.log('âœ… Database connected');

    // Synchronisation des modÃ¨les (attention en production!)
    await sequelize.sync({ force: true });
    console.log('ï¿½ Models synchronized');

    // DÃ©marrage du serveur
    app.listen(process.env.PORT, () =>
      console.log(`ğŸš€ App running on port ${process.env.PORT}`)
    );
  } catch (error) {
    console.error('ğŸ’¥ Bootstrap failed:', error);
    process.exit(1);
  }
};

bootstrap();</code></pre>
                    </div>

                    <div class="alert alert-warning">
                        <span class="alert-icon">âš ï¸</span>
                        <div>
                            <strong>Attention :</strong> <code>sync({ force: true })</code> supprime et recrÃ©e les tables. Ã€ utiliser uniquement en dÃ©veloppement !
                        </div>
                    </div>
                </div>
            </section>

            <!-- SystÃ¨me de rÃ©ponses -->
            <section id="responses" class="section">
                <h2>ğŸ“¤ 4. SystÃ¨me de rÃ©ponses standardisÃ©es</h2>
                
                <div id="status-enum" class="step">
                    <h3><span class="step-number">8</span>ğŸ¯ Ã‰numÃ©rations de status</h3>
                    <p>DÃ©finition centralisÃ©e des Ã©tats de service :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">utils/serviceStatus.enum.js</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>module.exports = {
    CREATED: 'Created',
    NOTFOUND: 'NotFound',
    OK: 'OK',
    BADREQUEST: 'BadRequest',
    NOCONTENT: 'NoContent',
};</code></pre>
                    </div>
                </div>

                <div id="mapping-http" class="step">
                    <h3><span class="step-number">9</span>ğŸ”„ Mapping Status â†’ HTTP</h3>
                    <p>Utilitaire pour convertir les status internes en codes HTTP :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">utils/statusToHttpCode.utils.js</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const ServiceStatus = require('./serviceStatus.enum');

module.exports = (status) => {
  switch (status) {
    case ServiceStatus.OK:
      return 200;
    case ServiceStatus.CREATED:
      return 201;
    case ServiceStatus.NOCONTENT:
      return 204;
    case ServiceStatus.BADREQUEST:
      return 400;
    case ServiceStatus.NOTFOUND:
      return 404;
    default:
      return 500;
  }
};</code></pre>
                    </div>
                </div>

                <div id="api-responses" class="step">
                    <h3><span class="step-number">10</span>ğŸ·ï¸ RÃ©ponses API standardisÃ©es</h3>
                    <p>Gestionnaire uniforme des rÃ©ponses HTTP :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">responses/apiCallResult.response.js</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const statusToHttp = require("../utils/statusToHttpCode.utils");

// Result => {ok, status, data?, error?}
module.exports = (res, result) => {
  const httpCode = statusToHttp(result.status);
  
  switch (httpCode) {
    case 201:
    case 204:
      // Pas de contenu pour Created/NoContent
      return res.status(httpCode).end();
    default:
      return res
        .status(httpCode)
        .json({ 
          data: result.data, 
          error: result.error 
        });
  }
};</code></pre>
                    </div>

                    <div class="alert alert-success">
                        <span class="alert-icon">âœ¨</span>
                        <div>
                            <strong>Avantage :</strong> Format de rÃ©ponse cohÃ©rent dans toute l'API. Les clients savent toujours quoi attendre : <code>{ data: ..., error: ... }</code>
                        </div>
                    </div>
                </div>

                <div id="service-results" class="step">
                    <h3><span class="step-number">11</span>âš™ï¸ RÃ©sultats de services internes</h3>
                    <p>Factory pour crÃ©er des rÃ©sultats de services :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">responses/serviceCallResult.response.js</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const ServiceStatus = require('../utils/serviceStatus.enum');

module.exports = {
  ok: (data) => ({
    ok: true,
    status: ServiceStatus.OK,
    data
  }),

  created: (data) => ({
    ok: true,
    status: ServiceStatus.CREATED,
    data
  }),

  notFound: (error) => ({
    ok: false,
    status: ServiceStatus.NOTFOUND,
    error
  }),

  badRequest: (error) => ({
    ok: false,
    status: ServiceStatus.BADREQUEST,
    error
  })
};</code></pre>
                    </div>

                    <div class="alert alert-info">
                        <span class="alert-icon">ğŸ”§</span>
                        <div>
                            <strong>Usage :</strong> Les services retournent toujours un objet standardisÃ© que les contrÃ´leurs transmettent directement Ã  <code>apiCallResult</code>.
                        </div>
                    </div>
                </div>
            </section>
                
                <div class="step">
                    <h3><span class="step-number">8</span>ğŸ‘¤ ModÃ¨le User</h3>
                    <p>CrÃ©ez <code>models/user.model.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const { DataTypes } = require('sequelize');
const { sequelize } = require('./index');

const User = sequelize.define('User', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  firstName: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [2, 50]
    }
  },
  lastName: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [2, 50]
    }
  },
  email: {
    type: DataTypes.STRING(100),
    allowNull: false,
    unique: true,
    validate: {
      isEmail: true
    }
  },
  password: {
    type: DataTypes.STRING(255),
    allowNull: false,
    validate: {
      len: [6, 255]
    }
  },
  isActive: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: 'users',
  timestamps: true, // createdAt, updatedAt
  paranoid: true,   // deletedAt (soft delete)
  hooks: {
    beforeCreate: (user) => {
      // Hash du mot de passe ici si nÃ©cessaire
    }
  }
});

module.exports = User;</code></pre>
                    </div>
                </div>

                <div class="step">
                    <h3><span class="step-number">9</span>ğŸš— ModÃ¨le Car</h3>
                    <p>CrÃ©ez <code>models/car.model.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const { DataTypes } = require('sequelize');
const { sequelize } = require('./index');

const Car = sequelize.define('Car', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  brand: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true
    }
  },
  model: {
    type: DataTypes.STRING(50),
    allowNull: false,
    validate: {
      notEmpty: true
    }
  },
  year: {
    type: DataTypes.INTEGER,
    allowNull: false,
    validate: {
      min: 1900,
      max: new Date().getFullYear() + 1
    }
  },
  price: {
    type: DataTypes.DECIMAL(10, 2),
    allowNull: false,
    validate: {
      min: 0
    }
  },
  color: {
    type: DataTypes.STRING(30),
    allowNull: true
  },
  isAvailable: {
    type: DataTypes.BOOLEAN,
    defaultValue: true
  }
}, {
  tableName: 'cars',
  timestamps: true,
  paranoid: true
});

module.exports = Car;</code></pre>
                    </div>
                </div>

                <div class="step">
                    <h3><span class="step-number">10</span>ğŸ”— Relations entre modÃ¨les</h3>
                    <p>CrÃ©ez <code>models/associations.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const User = require('./user.model');
const Car = require('./car.model');

// Un utilisateur peut avoir plusieurs voitures
User.hasMany(Car, {
  foreignKey: 'userId',
  as: 'cars'
});

// Une voiture appartient Ã  un utilisateur
Car.belongsTo(User, {
  foreignKey: 'userId',
  as: 'owner'
});

module.exports = { User, Car };</code></pre>
                    </div>
                </div>
            </section>

            <!-- Routes et ContrÃ´leurs -->
            <section id="routes" class="section">
                <h2>ğŸ›£ï¸ 7. ContrÃ´leurs et Routes</h2>
                
                <div id="controleurs" class="step">
                    <h3><span class="step-number">16</span>ğŸ›ï¸ ContrÃ´leur User</h3>
                    <p>CrÃ©ez <code>controllers/user.controller.js</code> avec les opÃ©rations CRUD complÃ¨tes :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const { User, Car } = require('../models/associations');
const { Op } = require('sequelize');

class UserController {
  // GET /api/users
  async getAllUsers(req, res, next) {
    try {
      const { page = 1, limit = 10, search } = req.query;
      const offset = (page - 1) * limit;
      
      const whereClause = search ? {
        [Op.or]: [
          { firstName: { [Op.iLike]: `%${search}%` } },
          { lastName: { [Op.iLike]: `%${search}%` } },
          { email: { [Op.iLike]: `%${search}%` } }
        ]
      } : {};

      const { count, rows: users } = await User.findAndCountAll({
        where: whereClause,
        include: [{
          model: Car,
          as: 'cars',
          attributes: ['id', 'brand', 'model', 'year']
        }],
        attributes: { exclude: ['password'] },
        limit: parseInt(limit),
        offset: parseInt(offset),
        order: [['createdAt', 'DESC']]
      });

      res.json({
        success: true,
        data: users,
        pagination: {
          currentPage: parseInt(page),
          totalPages: Math.ceil(count / limit),
          totalItems: count,
          itemsPerPage: parseInt(limit)
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // POST /api/users
  async createUser(req, res, next) {
    try {
      const { firstName, lastName, email, password } = req.body;
      
      const user = await User.create({
        firstName,
        lastName,
        email,
        password // Ã€ hasher dans un vrai projet
      });

      const { password: _, ...userWithoutPassword } = user.toJSON();

      res.status(201).json({
        success: true,
        data: userWithoutPassword,
        message: 'Utilisateur crÃ©Ã© avec succÃ¨s'
      });
    } catch (error) {
      if (error.name === 'SequelizeUniqueConstraintError') {
        return res.status(409).json({
          success: false,
          message: 'Cet email est dÃ©jÃ  utilisÃ©'
        });
      }
      next(error);
    }
  }
}

module.exports = new UserController();</code></pre>
                    </div>
                </div>

                <div id="routes-rest" class="step">
                    <h3><span class="step-number">17</span>ğŸ›£ï¸ Routes User</h3>
                    <p>CrÃ©ez <code>routes/users.routes.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const express = require('express');
const userController = require('../controllers/user.controller');
const { validateUser } = require('../middleware/validation');

const router = express.Router();

// Routes CRUD pour les utilisateurs
router.get('/', userController.getAllUsers);
router.get('/:id', userController.getUserById);
router.post('/', validateUser, userController.createUser);
router.put('/:id', userController.updateUser);
router.delete('/:id', userController.deleteUser);

module.exports = router;</code></pre>
                    </div>
                </div>

                <div id="validation" class="step">
                    <h3><span class="step-number">18</span>ğŸ—‚ï¸ Routes principales</h3>
                    <p>CrÃ©ez <code>routes/index.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn" aria-label="Copier le code">Copier</button>
                        </div>
                        <pre><code>const express = require('express');
const userRoutes = require('./users.routes');
const carRoutes = require('./cars.routes');

const router = express.Router();

// Route de santÃ©
router.get('/health', (req, res) => {
  res.json({
    success: true,
    message: 'API en fonctionnement',
    timestamp: new Date().toISOString()
  });
});

// Routes des modules
router.use('/users', userRoutes);
router.use('/cars', carRoutes);

module.exports = router;</code></pre>
                    </div>
                </div>
            </section>

            <!-- Middleware -->
            <section id="middleware" class="section">
                <h2>ğŸ›¡ï¸ 8. Middleware et gestion d'erreurs</h2>
                
                <div class="step">
                    <h3><span class="step-number">14</span>ğŸ”¥ Gestion d'erreurs</h3>
                    <p>CrÃ©ez <code>middleware/errorHandler.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>// Middleware pour les routes non trouvÃ©es
const notFoundHandler = (req, res, next) => {
  res.status(404).json({
    success: false,
    message: `Route ${req.originalUrl} non trouvÃ©e`,
    method: req.method
  });
};

// Middleware global de gestion d'erreurs
const errorHandler = (err, req, res, next) => {
  console.error('ğŸ”¥ Erreur:', {
    message: err.message,
    stack: err.stack,
    url: req.originalUrl,
    method: req.method,
    body: req.body,
    params: req.params,
    query: req.query
  });

  // Erreurs Sequelize
  if (err.name === 'SequelizeValidationError') {
    const errors = err.errors.map(e => ({
      field: e.path,
      message: e.message
    }));
    
    return res.status(400).json({
      success: false,
      message: 'Erreur de validation',
      errors
    });
  }

  if (err.name === 'SequelizeDatabaseError') {
    return res.status(500).json({
      success: false,
      message: 'Erreur de base de donnÃ©es'
    });
  }

  // Erreur par dÃ©faut
  res.status(err.status || 500).json({
    success: false,
    message: err.message || 'Erreur interne du serveur',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
};

module.exports = { notFoundHandler, errorHandler };</code></pre>
                    </div>
                </div>

                <div class="step">
                    <h3><span class="step-number">15</span>âœ… Validation</h3>
                    <p>CrÃ©ez <code>middleware/validation.js</code> :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const { body, validationResult } = require('express-validator');

// Middleware de validation pour User
const validateUser = [
  body('firstName')
    .notEmpty()
    .withMessage('Le prÃ©nom est requis')
    .isLength({ min: 2, max: 50 })
    .withMessage('Le prÃ©nom doit contenir entre 2 et 50 caractÃ¨res'),
  
  body('lastName')
    .notEmpty()
    .withMessage('Le nom est requis')
    .isLength({ min: 2, max: 50 })
    .withMessage('Le nom doit contenir entre 2 et 50 caractÃ¨res'),
  
  body('email')
    .isEmail()
    .withMessage('Email invalide')
    .normalizeEmail(),
  
  body('password')
    .isLength({ min: 6 })
    .withMessage('Le mot de passe doit contenir au moins 6 caractÃ¨res'),

  // Middleware pour vÃ©rifier les rÃ©sultats
  (req, res, next) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'Erreurs de validation',
        errors: errors.array()
      });
    }
    next();
  }
];

module.exports = { validateUser };</code></pre>
                    </div>
                </div>
            </section>

            <!-- Assemblage -->
            <section id="assemblage" class="section">
                <h2>ğŸ”§ 9. Assemblage final</h2>
                
                <div class="step">
                    <h3><span class="step-number">16</span>ğŸ”„ Mise Ã  jour models/index.js</h3>
                    <p>Version finale avec import des modÃ¨les :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">javascript</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code>const { Sequelize } = require('sequelize');
require('dotenv').config();

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT || 3306,
    dialect: process.env.DB_DIALECT || 'mysql',
    logging: process.env.NODE_ENV === 'development' ? console.log : false
  }
);

// Import des modÃ¨les
const User = require('./user.model');
const Car = require('./car.model');

// Configuration des associations
require('./associations');

// Test de connexion
const testConnection = async () => {
  try {
    await sequelize.authenticate();
    console.log('âœ… Connexion Ã  la base de donnÃ©es rÃ©ussie');
  } catch (error) {
    console.error('âŒ Erreur de connexion:', error);
    throw error;
  }
};

module.exports = {
  sequelize,
  testConnection,
  User,
  Car
};</code></pre>
                    </div>
                </div>

                <div class="step">
                    <h3>ğŸš€ Test de l'API</h3>
                    <p>Commandes pour tester votre API :</p>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">bash</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code># DÃ©marrage en dÃ©veloppement
npm run dev

# Test de l'API
curl http://localhost:3000/api/health

# Test crÃ©ation d'utilisateur
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{"firstName":"Jean","lastName":"Dupont","email":"jean@example.com","password":"123456"}'</code></pre>
                    </div>
                </div>
            </section>

            <!-- Bonnes pratiques -->
            <section id="bonnes-pratiques" class="section">
                <h2>âœ… 10. Bonnes pratiques</h2>
                
                <div class="step">
                    <h3>ğŸ“‹ Liste de contrÃ´le</h3>
                    
                    <h4>ğŸ›¡ï¸ SÃ©curitÃ©</h4>
                    <ul class="checklist">
                        <li>Variables d'environnement pour les secrets</li>
                        <li>Validation des entrÃ©es utilisateur</li>
                        <li>Limitation du taux de requÃªtes (rate limiting)</li>
                        <li>Hashage des mots de passe</li>
                        <li>Headers de sÃ©curitÃ© (helmet)</li>
                        <li>CORS configurÃ© correctement</li>
                    </ul>

                    <h4>âš¡ Performance</h4>
                    <ul class="checklist">
                        <li>Pagination pour les listes</li>
                        <li>Index sur les colonnes frÃ©quemment recherchÃ©es</li>
                        <li>Limitation de la taille des requÃªtes</li>
                        <li>Pool de connexions configurÃ©</li>
                    </ul>

                    <h4>ğŸ”§ Maintenance</h4>
                    <ul class="checklist">
                        <li>Logs structurÃ©s</li>
                        <li>Gestion d'erreurs centralisÃ©e</li>
                        <li>Tests unitaires</li>
                        <li>Documentation API (Swagger)</li>
                        <li>Scripts de migration</li>
                        <li>Monitoring et santÃ© de l'API</li>
                    </ul>
                </div>

                <div class="step">
                    <h3>ğŸ” Commandes utiles</h3>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">bash</span>
                            <button class="copy-btn">Copier</button>
                        </div>
                        <pre><code># DÃ©marrage en dÃ©veloppement
npm run dev

# Test de l'API
curl http://localhost:3000/api/health

# Migration de base de donnÃ©es
npx sequelize-cli migration:generate --name create-users
npx sequelize-cli db:migrate

# Seeders (donnÃ©es de test)
npx sequelize-cli seed:generate --name demo-users
npx sequelize-cli db:seed:all</code></pre>
                    </div>
                </div>

                <div class="step">
                    <h3>ğŸš« Erreurs courantes Ã  Ã©viter</h3>
                    
                    <div class="alert alert-danger">
                        <span class="alert-icon">âš ï¸</span>
                        <div>
                            <strong>Attention Ã  ces piÃ¨ges :</strong>
                            <ol>
                                <li>Oublier la gestion d'erreurs async/await</li>
                                <li>Ne pas valider les entrÃ©es utilisateur</li>
                                <li>Exposer les mots de passe dans les rÃ©ponses</li>
                                <li>Pas de pagination sur les listes</li>
                                <li>Connexions DB non fermÃ©es</li>
                                <li>Logs sensibles en production</li>
                                <li>Synchronisation forcÃ©e en production (<code>force: true</code>)</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <h3>ğŸ“š Ressources utiles</h3>
                    <ul>
                        <li><a href="https://sequelize.org/docs/v6/" target="_blank">ğŸ“– Documentation Sequelize</a></li>
                        <li><a href="https://expressjs.com/fr/guide/" target="_blank">ğŸš€ Express.js Guide</a></li>
                        <li><a href="https://github.com/goldbergyoni/nodebestpractices" target="_blank">â­ Node.js Best Practices</a></li>
                        <li><a href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design" target="_blank">ğŸ—ï¸ API Design Guidelines</a></li>
                    </ul>
                </div>

                <div class="alert alert-success">
                    <span class="alert-icon">ğŸ’¡</span>
                    <div>
                        <strong>Conseil final :</strong> Commencez simple, testez chaque Ã©tape, et ajoutez les fonctionnalitÃ©s progressivement. Une API qui fonctionne avec des fonctionnalitÃ©s de base vaut mieux qu'une API complexe qui ne dÃ©marre pas !
                    </div>
                </div>
            </section>

            <!-- Navigation de fin -->
            <div class="page-navigation">
                <a href="#introduction" class="nav-link">
                    â¬†ï¸ Retour au dÃ©but
                </a>
                <a href="https://github.com" target="_blank" class="nav-link">
                    ğŸ“‚ Voir sur GitHub
                </a>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <p>ğŸš€ Guide API Express + Sequelize - CrÃ©Ã© avec â¤ï¸ pour les dÃ©veloppeurs</p>
                <p>DerniÃ¨re mise Ã  jour : <span id="last-update"></span></p>
            </footer>
        </main>
    </div>

    <script src="assets/script.js"></script>
    <script>
        // Afficher la date de derniÃ¨re mise Ã  jour
        document.getElementById('last-update').textContent = new Date().toLocaleDateString('fr-FR');
    </script>
</body>
</html>